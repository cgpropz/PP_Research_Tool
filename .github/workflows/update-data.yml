name: Update NBA UI Data

on:
  schedule:
    - cron: '*/5 * * * *'          # PP odds every 5 minutes
  workflow_dispatch:
    inputs:
      run_gamelogs:
        description: 'Force run full Gamelogs scrape (Playwright)'
        required: true
        default: false
        type: boolean
      run_dvp:
        description: 'Force refresh DVP data'
        required: true
        default: false
        type: boolean

  push:
    branches: [ main ]
    paths:
      - 'player-template-new.html'
      - 'generate_players.py'
      - 'UI_DATA_BUILDER_PERFECT.py'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      PP_API_KEY: ${{ secrets.PP_API_KEY }}
      PP_API_URL: ${{ secrets.PP_API_URL }}
      DVP_API_URL: ${{ secrets.DVP_API_URL }}
      BR_USER_AGENT: ${{ secrets.BR_USER_AGENT }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies (Playwright)
        run: |
          pip install --upgrade pip
          pip install playwright pandas
          python -m playwright install

      - name: Update PP Odds (always)
        run: python Fetch_PP_Odds.py || true

      - name: Sync root odds JSON
        run: |
          [ -f data/odds/latest.json ] && cp -f data/odds/latest.json ODDS_LATEST.json || echo "No latest.json"

      # MANUAL + DAILY GAMEL0GS TRIGGER with Playwright
      - name: Run Full Gamelogs Scrape (Playwright)
        run: |
          echo "Running full Gamelogs scrape (Playwright)..."
          python Gamelogs.py && echo "Gamelogs scraped!" || (
            echo "Gamelogs failed → trying backup"
            python Fetch_Gamelogs.py || true
          )

      # MANUAL DVP TRIGGER
      - name: Force DVP Refresh
        if: github.event_name == 'workflow_dispatch' && inputs.run_dvp == 'true'
        run: python dvp_parser.py || true

      # AUTO DVP (daily + stale check)
      - name: Auto DVP Refresh (daily or stale)
        if: github.event_name != 'workflow_dispatch' || inputs.run_dvp != 'true'
        run: |
          if [ ! -f nba_dvp_latest.json ]; then
            echo "DVP missing → fetching"
            python dvp_parser.py || true
          else
            AGE=$(( ($(date +%s) - $(stat -c %Y nba_dvp_latest.json)) / 3600 ))
            if [ $AGE -ge 6 ]; then
              echo "DVP stale (${AGE}h) → refreshing"
              python dvp_parser.py || true
            else
              echo "DVP fresh (${AGE}h) → skipping"
            fi
          fi

      - name: Regenerate player pages
        run: |
          PP_LINES_PATH=NBA_PURE_STANDARD_SINGLE.json python UI_DATA_BUILDER_PERFECT.py || true
          python generate_players.py || true

      - name: Log summary
        run: |
          mkdir -p logs
          echo "$(date -u) • ${{ github.event_name }} • run_id=${{ github.run_id }}" >> logs/update_data.log
          echo "Gamelogs: $( [ -f Full_Gamelogs25.csv ] && echo yes || echo no )" >> logs/update_data.log
          echo "Players: $(ls -1 players 2>/dev/null | wc -l) files" >> logs/update_data.log
          echo "---" >> logs/update_data.log

      - name: Commit & push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: data refresh (gamelogs: ${{ github.event_name == 'workflow_dispatch' && inputs.run_gamelogs == 'true' && 'manual' || 'auto' }})"
          file_pattern: |
            *.json *.csv
            players/**
            logs/**
